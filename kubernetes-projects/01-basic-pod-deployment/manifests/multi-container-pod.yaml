apiVersion: v1
kind: Pod
metadata:
  name: multi-container-pod
  labels:
    app: webapp
    pattern: sidecar
    env: learning
spec:
  containers:
  # Main application container
  - name: main-app
    image: nginx:1.25-alpine
    ports:
    - containerPort: 80
    volumeMounts:
    - name: shared-logs
      mountPath: /var/log/nginx
    env:
    - name: APP_NAME
      value: "main-application"
  
  # Sidecar container for log processing
  - name: sidecar-logger
    image: busybox:1.36
    command: ["/bin/sh"]
    args:
    - -c
    - >
      while true;
      do
        echo "[$(date)] Processing logs from main app..." >> /var/log/sidecar.log;
        if [ -f /var/log/nginx/access.log ]; then
          echo "Access log entries: $(wc -l < /var/log/nginx/access.log)" >> /var/log/sidecar.log;
        fi;
        sleep 10;
      done
    volumeMounts:
    - name: shared-logs
      mountPath: /var/log/nginx
  
  # Shared volume between containers
  volumes:
  - name: shared-logs
    emptyDir: {}
